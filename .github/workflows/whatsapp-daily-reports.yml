name: WhatsApp Daily Reports

on:
  schedule:
    # Morning report at 10:00 AM Madrid time - Tuesday to Friday only
    # TEMPORAL: Semana del 9-13 dic 2024, empezar MARTES porque lunes 8 es festivo
    # TODO: Volver a cambiar a '0 9 * * 1-5' después del 10 de diciembre
    # 09:00 UTC in winter (Nov-Mar), 08:00 UTC in summer (Apr-Oct)
    - cron: '0 9 * * 2-5'

    # Afternoon report at 13:00 Madrid time - Tuesday to Friday only
    # TEMPORAL: Semana del 9-13 dic 2024, empezar MARTES porque lunes 8 es festivo
    # TODO: Volver a cambiar a '0 12 * * 1-5' después del 10 de diciembre
    # 12:00 UTC in winter (Nov-Mar), 11:00 UTC in summer (Apr-Oct)
    - cron: '0 12 * * 2-5'

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      reportType:
        description: 'Report type (morning or afternoon)'
        required: true
        default: 'morning'
        type: choice
        options:
          - morning
          - afternoon

jobs:
  trigger-reports:
    runs-on: ubuntu-latest

    steps:
      - name: Determine report type
        id: report-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.reportType }}" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            if [ "$HOUR" = "09" ] || [ "$HOUR" = "08" ]; then
              echo "type=morning" >> $GITHUB_OUTPUT
            else
              echo "type=afternoon" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Trigger WhatsApp Reports
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -d '{"reportType": "${{ steps.report-type.outputs.type }}", "cronSecret": "${{ secrets.CRON_SECRET }}"}' \
            ${{ secrets.SUPABASE_URL }}/functions/v1/trigger-scheduled-reports

      - name: Report result
        run: |
          echo "Triggered ${{ steps.report-type.outputs.type }} report successfully"
